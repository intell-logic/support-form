name: ğŸ« Process Support Tickets

on:
  repository_dispatch:
    types: [ticket_created]

jobs:
  create-clickup-task:
    runs-on: ubuntu-latest
    name: ğŸ“ Create ClickUp Task
    
    steps:
    - name: ğŸ” Debug Payload
      run: |
        echo "Event Type: ${{ github.event.action }}"
        echo "Payload Keys: ${{ toJson(github.event.client_payload) }}"
    
    - name: ğŸ¯ Create ClickUp Task
      uses: actions/github-script@v7
      with:
        script: |
          const ticketData = context.payload.client_payload;
          
          console.log('ğŸ“¥ Received ticket data:', JSON.stringify(ticketData, null, 2));
          
          // Mapear prioridad a nÃºmeros de ClickUp
          const priorityMap = {
            'urgente': 1,
            'alta': 2, 
            'media': 3,
            'baja': 4
          };
          
          // Preparar datos para ClickUp
          const clickupTask = {
            name: ticketData.titulo,
            description: `ğŸ« **Ticket ID:** ${ticketData.id}
            ğŸ“… **Fecha:** ${ticketData.fechaLocal || new Date().toLocaleString('es-ES')}
            ğŸ·ï¸ **Tipo:** ${ticketData.etiqueta}
            ğŸš¨ **Prioridad:** ${ticketData.prioridad}
            ğŸŒ **Origen:** Formulario Web

            **ğŸ“ DescripciÃ³n del Cliente:**
            ${ticketData.descripcion}

            **ğŸ” InformaciÃ³n TÃ©cnica:**
          - User Agent: ${ticketData.cliente?.userAgent || 'N/A'}
          - Plataforma: ${ticketData.cliente?.plataforma || 'N/A'}
          - Idioma: ${ticketData.cliente?.idioma || 'N/A'}
          - URL Origen: ${ticketData.cliente?.url || 'N/A'}
---
*âœ¨ Creado automÃ¡ticamente vÃ­a GitHub Actions*
*â° Procesado: ${new Date().toLocaleString('es-ES')}*`,
            
            priority: priorityMap[ticketData.prioridad] || 3,
            status: 'to do',
            tags: [
              'formulario-web',
              ticketData.etiqueta,
              `prioridad-${ticketData.prioridad}`,
              'github-actions'
            ]
          };
          
          console.log('ğŸ“¤ Sending to ClickUp:', JSON.stringify(clickupTask, null, 2));
          
          // Enviar a ClickUp API
          const response = await fetch(`https://api.clickup.com/api/v2/list/${process.env.CLICKUP_LIST_ID}/task`, {
            method: 'POST',
            headers: {
              'Authorization': process.env.CLICKUP_API_TOKEN,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(clickupTask)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ ClickUp API Error:', response.status, errorText);
            throw new Error(`ClickUp API Error: ${response.status} - ${errorText}`);
          }
          
          const result = await response.json();
          console.log('âœ… ClickUp Task Created:', result.id);
          console.log('ğŸ”— Task URL:', result.url);
          
          // Comentar en el PR/Issue si existe
          if (context.issue?.number) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… **Ticket procesado exitosamente**
              
ğŸ« **Ticket ID:** ${ticketData.id}
ğŸ“‹ **ClickUp Task ID:** ${result.id}
ğŸ”— **Ver en ClickUp:** ${result.url}
ğŸ“… **Procesado:** ${new Date().toLocaleString('es-ES')}`
            });
          }
          
      env:
        CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
        CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
