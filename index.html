<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tickets - Soporte</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .header-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            opacity: 0.9;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .header-logo:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
            margin: 0;
        }

        .form-group {
            margin-bottom: 30px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
            color: #2d3748;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #ef4444;
            background: #fef2f2;
            animation: shake 0.5s ease-in-out;
        }

        .form-group input.error:focus,
        .form-group select.error:focus,
        .form-group textarea.error:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }

        .form-group input.success,
        .form-group select.success,
        .form-group textarea.success {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 50px;
        }

        .error-message {
            display: block;
            color: #ef4444;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 6px;
            margin-left: 2px;
            line-height: 1.3;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }

        .error-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .error-message::before {
            content: "‚ö†Ô∏è ";
            margin-right: 4px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .priority-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-low { background: #c6f6d5; color: #22543d; }
        .priority-medium { background: #fed7aa; color: #c05621; }
        .priority-high { background: #fecaca; color: #991b1b; }
        .priority-urgent { background: #ddd6fe; color: #5b21b6; }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .submit-btn:active {
            transform: translateY(-1px);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .error-message-global {
            background: #fecaca;
            border: 1px solid #f87171;
            color: #991b1b;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .form-footer p {
            color: #718096;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .header-content {
                align-items: center;
                text-align: center;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header-logo {
                width: 50px;
                height: 50px;
            }
        }

        .field-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 1.2rem;
        }
    </style>
    <script src="./api.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="./assets/img/logo.png" alt="Logo" class="header-logo">
            <div class="header-content">
                <h1>Sistema de Tickets</h1>
                <p>Describe tu problema y nuestro equipo te ayudar√°</p>
            </div>
        </div>

        <div id="successMessage" class="success-message">
            ‚úÖ Tu ticket ha sido enviado exitosamente. Te contactaremos pronto.
        </div>

        <div id="errorMessage" class="error-message-global">
            ‚ùå Error al enviar el ticket. Por favor, intenta nuevamente.
        </div>

        <form id="ticketForm">
            <div class="form-group">
                <label for="titulo">üè∑Ô∏è T√≠tulo del Ticket</label>
                <input type="text" id="titulo" name="titulo" placeholder="Ej: Problema con la aplicaci√≥n m√≥vil">
                <span class="error-message" id="titulo-error">El t√≠tulo es obligatorio y debe tener al menos 5 caracteres</span>
            </div>

            <div class="form-group">
                <label for="descripcion">üìù Descripci√≥n Detallada</label>
                <textarea id="descripcion" name="descripcion" placeholder="Describe tu problema con el mayor detalle posible. Incluye pasos para reproducir el error si es aplicable."></textarea>
                <span class="error-message" id="descripcion-error">La descripci√≥n es obligatoria y debe tener al menos 20 caracteres</span>
            </div>

            <div class="form-group">
                <label for="prioridad">üö® Prioridad</label>
                <select id="prioridad" name="prioridad">
                    <option value="">Selecciona una prioridad</option>
                    <option value="baja">üü¢ Baja - No es urgente</option>
                    <option value="media">üü° Media - Necesita atenci√≥n</option>
                    <option value="alta">üü† Alta - Requiere pronta soluci√≥n</option>
                    <option value="urgente">üî¥ Urgente - Cr√≠tico para el negocio</option>
                </select>
                <span class="error-message" id="prioridad-error">Debes seleccionar una prioridad</span>
            </div>

            <div class="form-group">
                <label for="etiqueta">üè∑Ô∏è Tipo de Ticket</label>
                <select id="etiqueta" name="etiqueta">
                    <option value="">Selecciona el tipo</option>
                    <option value="bug">üêõ Error/Bug</option>
                    <option value="feature">‚ú® Nueva Funcionalidad</option>
                    <option value="soporte">üí¨ Soporte T√©cnico</option>
                    <option value="consulta">‚ùì Consulta General</option>
                    <option value="mejora">üîß Mejora</option>
                    <option value="acceso">üîë Problemas de Acceso</option>
                    <option value="rendimiento">‚ö° Rendimiento</option>
                    <option value="otro">üìå Otro</option>
                </select>
                <span class="error-message" id="etiqueta-error">Debes seleccionar un tipo de ticket</span>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                Enviar Ticket
            </button>
        </form>

        <div class="form-footer">
            <p>üí° Tip: Proporciona la mayor informaci√≥n posible para una resoluci√≥n m√°s r√°pida</p>
        </div>
    </div>

    <script>
        // Configuraci√≥n NETLIFY FUNCTIONS (segura y sin CORS)
        const NETLIFY_FUNCTION_URL = 'https://support-form-dms.netlify.app/.netlify/functions/tickets';
        
        // Configuraci√≥n adicional para debugging
        const DEBUG_MODE = true;

        const form = document.getElementById('ticketForm');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // Configuraci√≥n de validaciones personalizadas
        const validationRules = {
            titulo: {
                required: true,
                minLength: 5,
                message: 'El t√≠tulo es obligatorio y debe tener al menos 5 caracteres'
            },
            descripcion: {
                required: true,
                minLength: 20,
                message: 'La descripci√≥n es obligatoria y debe tener al menos 20 caracteres'
            },
            prioridad: {
                required: true,
                message: 'Debes seleccionar una prioridad'
            },
            etiqueta: {
                required: true,
                message: 'Debes seleccionar un tipo de ticket'
            }
        };

        // Funci√≥n para mostrar badge de prioridad
        function updatePriorityDisplay() {
            const prioridadSelect = document.getElementById('prioridad');
            const existingBadge = document.querySelector('.priority-badge');
            
            if (existingBadge) {
                existingBadge.remove();
            }

            if (prioridadSelect.value) {
                const badge = document.createElement('span');
                badge.className = `priority-badge priority-${prioridadSelect.value}`;
                badge.textContent = prioridadSelect.value;
                prioridadSelect.parentNode.appendChild(badge);
            }
        }

        document.getElementById('prioridad').addEventListener('change', updatePriorityDisplay);

        // Funci√≥n para mostrar error de validaci√≥n
        function showFieldError(fieldName, message) {
            const field = document.getElementById(fieldName);
            const errorElement = document.getElementById(`${fieldName}-error`);
            
            field.classList.add('error');
            field.classList.remove('success');
            
            if (message) {
                errorElement.textContent = message;
            }
            errorElement.classList.add('show');
        }

        // Funci√≥n para mostrar √©xito de validaci√≥n
        function showFieldSuccess(fieldName) {
            const field = document.getElementById(fieldName);
            const errorElement = document.getElementById(`${fieldName}-error`);
            
            field.classList.remove('error');
            field.classList.add('success');
            errorElement.classList.remove('show');
        }

        // Funci√≥n para validar un campo espec√≠fico
        function validateField(fieldName, value) {
            const rules = validationRules[fieldName];
            if (!rules) return true;

            // Validar campo requerido
            if (rules.required && (!value || value.trim().length === 0)) {
                showFieldError(fieldName, rules.message);
                return false;
            }

            // Validar longitud m√≠nima
            if (rules.minLength && value.trim().length < rules.minLength) {
                showFieldError(fieldName, rules.message);
                return false;
            }

            // Si llega aqu√≠, la validaci√≥n es exitosa
            showFieldSuccess(fieldName);
            return true;
        }

        // Funci√≥n para validar todo el formulario
        function validateForm() {
            let isValid = true;
            
            // Obtener valores del formulario
            const formData = new FormData(form);
            
            // Validar cada campo
            Object.keys(validationRules).forEach(fieldName => {
                const value = formData.get(fieldName) || '';
                if (!validateField(fieldName, value)) {
                    isValid = false;
                }
            });

            return isValid;
        }

        // Funci√≥n para limpiar mensajes
        function clearMessages() {
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
        }

        // Funci√≥n para limpiar todos los errores de validaci√≥n
        function clearValidationErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
            });
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.classList.remove('error', 'success');
            });
        }

        // Funci√≥n para mostrar estado de carga
        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.innerHTML = '<span class="loading"></span>Enviando...';
                submitBtn.disabled = true;
            } else {
                submitBtn.innerHTML = 'Enviar Ticket';
                submitBtn.disabled = false;
            }
        }

        // Funci√≥n para generar ID √∫nico del ticket
        function generateTicketId() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substr(2, 5);
            return `TICKET-${timestamp}-${random}`.toUpperCase();
        }

        // Funci√≥n para enviar datos v√≠a Netlify Functions (M√ÅS SEGURA)
        async function sendViaNetlify(ticketData) {
            try {
                if (DEBUG_MODE) {
                    console.log('üì§ Enviando v√≠a Netlify Functions:', ticketData);
                    console.log('üîó URL:', NETLIFY_FUNCTION_URL);
                }

                const response = await fetch(NETLIFY_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'User-Agent': 'Ticket-Form/1.0'
                    },
                    body: JSON.stringify(ticketData)
                });

                if (DEBUG_MODE) {
                    console.log('üì• Netlify status:', response.status);
                }

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Netlify Error: ${response.status} - ${errorData}`);
                }

                const result = await response.json();
                
                if (DEBUG_MODE) {
                    console.log('‚úÖ Respuesta Netlify:', result);
                }
                
                return result;

            } catch (error) {
                console.error('‚ùå Error Netlify:', error);
                if (DEBUG_MODE) {
                    console.error('üìç Detalles del error:', {
                        message: error.message,
                        url: NETLIFY_FUNCTION_URL,
                        data: ticketData
                    });
                }
                throw error;
            }
        }

        // Manejador del formulario
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            clearMessages();
            
            // Validar formulario antes de enviar
            if (!validateForm()) {
                errorMessage.textContent = '‚ùå Por favor, corrige los errores antes de continuar.';
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            setLoading(true);

            // Recopilar datos del formulario con estructura optimizada para n8n/ClickUp
            const formData = new FormData(form);
            const ticketData = {
                // Datos principales
                id: generateTicketId(),
                titulo: formData.get('titulo').trim(),
                descripcion: formData.get('descripcion').trim(),
                prioridad: formData.get('prioridad'),
                etiqueta: formData.get('etiqueta'),
                
                // Metadatos para ClickUp
                fechaCreacion: new Date().toISOString(),
                fechaLocal: new Date().toLocaleString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                estado: 'nuevo',
                origen: 'formulario-web',
                
                // Informaci√≥n del cliente/navegador
                cliente: {
                    userAgent: navigator.userAgent,
                    idioma: navigator.language,
                    plataforma: navigator.platform,
                    timestamp: Date.now(),
                    url: window.location.href,
                    referrer: document.referrer || 'directo'
                },
                
                // Datos estructurados para facilitar el mapeo en n8n
                clickupData: {
                    // Mapeo de prioridades para ClickUp (1=urgent, 4=low)
                    prioridad_numerica: formData.get('prioridad') === 'urgente' ? 1 :
                                       formData.get('prioridad') === 'alta' ? 2 :
                                       formData.get('prioridad') === 'media' ? 3 : 4,
                    
                    // Tags sugeridos para ClickUp
                    tags: [
                        'formulario-web',
                        formData.get('etiqueta'),
                        `prioridad-${formData.get('prioridad')}`,
                        'sin-asignar'
                    ],
                    
                    // Estado inicial sugerido
                    estado_inicial: 'to do',
                    
                    // Descripci√≥n formateada para ClickUp
                    descripcion_formateada: `üé´ **Ticket ID:** ${generateTicketId()}
üìÖ **Fecha:** ${new Date().toLocaleString('es-ES')}
üè∑Ô∏è **Tipo:** ${formData.get('etiqueta')}
üö® **Prioridad:** ${formData.get('prioridad')}

**Descripci√≥n del Cliente:**
${formData.get('descripcion').trim()}

---
*Creado autom√°ticamente desde el formulario web*
*User Agent: ${navigator.userAgent.substring(0, 100)}...*`
                }
            };

            try {
                // Enviar v√≠a Netlify Functions
                await sendViaNetlify(ticketData);
                
                // Mostrar mensaje de √©xito
                successMessage.style.display = 'block';
                form.reset();
                clearValidationErrors();
                updatePriorityDisplay();
                
                // Scroll al mensaje de √©xito
                successMessage.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = '‚ùå Error al procesar el ticket. Por favor, intenta nuevamente.';
                errorMessage.style.display = 'block';
                errorMessage.scrollIntoView({ behavior: 'smooth' });
            } finally {
                setLoading(false);
            }
        });

        // Validaci√≥n en tiempo real mientras el usuario escribe/selecciona
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            // Validaci√≥n en tiempo real mientras escribe (con debounce)
            let validationTimeout;
            input.addEventListener('input', function() {
                clearTimeout(validationTimeout);
                validationTimeout = setTimeout(() => {
                    if (this.value.trim().length > 0) {
                        validateField(this.name, this.value);
                    }
                }, 500); // Esperar 500ms despu√©s de que pare de escribir
            });

            // Validaci√≥n inmediata al salir del campo
            input.addEventListener('blur', function() {
                if (validationRules[this.name]) {
                    validateField(this.name, this.value);
                }
            });

            // Limpiar errores al hacer focus si el campo ten√≠a error
            input.addEventListener('focus', function() {
                if (this.classList.contains('error')) {
                    this.classList.remove('error');
                    const errorElement = document.getElementById(`${this.name}-error`);
                    if (errorElement) {
                        errorElement.classList.remove('show');
                    }
                }
            });
        });

        // Animaci√≥n de entrada
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.querySelector('.container');
            container.style.opacity = '0';
            container.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                container.style.transition = 'all 0.6s ease';
                container.style.opacity = '1';
                container.style.transform = 'translateY(0)';
            }, 100);
        });

        // Log de configuraci√≥n para debugging
        console.log('üìã Formulario de Tickets Inicializado - Netlify Functions');
        console.log('üîó Function URL:', NETLIFY_FUNCTION_URL);
        console.log('üåç Origin:', window.location.origin);
        console.log('üìù Campos disponibles: t√≠tulo, descripci√≥n, prioridad, etiqueta');
        console.log('‚ö° Procesamiento v√≠a Netlify Functions ‚Üí ClickUp');
        
        // Test de conectividad Netlify
        if (DEBUG_MODE) {
            console.log('üîç Para probar Netlify Function, ejecuta en consola:');
            console.log(`fetch('${NETLIFY_FUNCTION_URL}', {
                method: 'OPTIONS'
            }).then(r => r.json()).then(d => console.log('‚úÖ Netlify OK:', d)).catch(e => console.error('‚ùå Error:', e))`);
        }
    </script>
</body>
</html>
